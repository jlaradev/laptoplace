<!-- Toast flotante (debajo del header, sin taparlo) -->
<div class="fixed right-6 z-50 top-20 pointer-events-none">
  <div *ngIf="toastVisible" class="min-w-[200px] max-w-sm bg-red-600 text-white px-4 py-3 rounded shadow-lg transition-opacity duration-300">
    {{ toastMsg }}
  </div>
</div>
<app-header></app-header>
<div class="payment-bg">
  <div *ngIf="mostrarOverlayError" class="payment-overlay-error">
    <div class="payment-overlay-content">
      <span class="payment-overlay-icon">&#9888;</span>
      <h2 *ngIf="error && error.toLowerCase().includes('unidades disponibles')">Ya no hay suficientes unidades disponibles</h2>
      <h2 *ngIf="!error || !error.toLowerCase().includes('unidades disponibles')">Transacción rechazada</h2>
      <p>Serás redirigido al carrito...</p>
    </div>
  </div>
  <div *ngIf="mostrarOverlayAprobada" class="payment-overlay-success">
    <div class="payment-overlay-content">
      <span class="payment-overlay-icon">&#10004;</span>
      <h2>Transacción aprobada</h2>
      <p>Serás redirigido al carrito...</p>
    </div>
  </div>
  <div class="payment-flex-container" [class.blur-sm]="mostrarOverlayError">
    <div class="payment-flex-card">
      <div class="payment-flex-left-right">
        <div class="payment-flex-left">
          <div *ngIf="error && (!mostrarOverlayError || !error.toLowerCase().includes('unidades disponibles'))" class="payment-error">{{ error }}</div>
          <!-- Dirección de entrega -->
          <div *ngIf="userLoaded && !direccionConfirmada">
            <label class="block font-semibold mb-2">Dirección de entrega</label>
            <div *ngIf="!mostrarFormularioDireccion">
              <div class="mb-2">{{ direccionEnvio || 'No disponible' }}</div>
                <button class="px-4 py-1 payment-btn-gray mr-2" (click)="usarOtraDireccion()">Usar otra dirección</button>
              <button class="px-6 py-2 bg-blue-600 text-white rounded font-semibold shadow hover:bg-blue-700 transition mt-2 payment-confirm-btn" (click)="iniciarPago()" [disabled]="!direccionEnvio || loading">
                {{ loading ? 'Procesando...' : 'Confirmar dirección de entrega' }}
              </button>
            </div>
            <div *ngIf="mostrarFormularioDireccion">
              <input class="border rounded px-3 py-2 w-full mb-2" [(ngModel)]="direccionEnvio" placeholder="Ingresa nueva dirección" />
                <button class="px-4 py-1 payment-btn-gray mr-2" (click)="cancelarOtraDireccion()">Cancelar</button>
              <button class="px-6 py-2 bg-blue-600 text-white rounded font-semibold shadow hover:bg-blue-700 transition payment-confirm-btn" (click)="iniciarPago()" [disabled]="!direccionEnvio || loading">
                {{ loading ? 'Procesando...' : 'Confirmar dirección de entrega' }}
              </button>
            </div>
          </div>
          <!-- Stripe Elements: siempre presente, pero oculto si no está confirmada la dirección -->
          <div #paymentForm id="payment-form" [style.display]="direccionConfirmada ? 'block' : 'none'"></div>
        </div>
        <div class="payment-flex-right" *ngIf="items.length > 0">
          <h2 class="payment-summary-title">Resumen del pedido</h2>
          <ul>
            <li *ngFor="let item of items">
              <img *ngIf="item.imagenUrl" [src]="item.imagenUrl" width="40" height="40"
                style="vertical-align:middle;margin-right:8px;" />
              {{ item.nombre }} x {{ item.cantidad }} — ${{ item.precio }}
            </li>
          </ul>
          <div class="font-bold mt-2">Total: ${{ total }}</div>
          <button
            class="px-6 py-2 bg-green-600 text-white rounded font-semibold shadow hover:bg-green-700 transition mt-6 w-full payment-confirm-btn"
            [disabled]="loading"
            (click)="confirmarPago()"
            *ngIf="clientSecret && items.length > 0 && direccionConfirmada"
          >
            {{ loading ? 'Procesando pago...' : 'Confirmar pago' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<app-footer></app-footer>